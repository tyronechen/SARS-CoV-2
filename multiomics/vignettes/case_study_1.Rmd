---
title: "Case study 1"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Case study 1}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r init, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r global-options, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=8, fig.path='figs/',
                      echo=TRUE, warning=FALSE, message=FALSE)
```

Copyright (c) 2020 <a href="https://orcid.org/0000-0002-9207-0385">Tyrone Chen <img alt="ORCID logo" src="https://info.orcid.org/wp-content/uploads/2019/11/orcid_16x16.png" width="16" height="16" /></a>, <a href="https://orcid.org/0000-0002-0827-866X">Melcy Philip <img alt="ORCID logo" src="https://info.orcid.org/wp-content/uploads/2019/11/orcid_16x16.png" width="16" height="16" /></a>, <a href="https://orcid.org/0000-0003-3923-1116">Kim-Anh LÃª Cao <img alt="ORCID logo" src="https://info.orcid.org/wp-content/uploads/2019/11/orcid_16x16.png" width="16" height="16" /></a>, <a href="https://orcid.org/0000-0003-0181-6258">Sonika Tyagi <img alt="ORCID logo" src="https://info.orcid.org/wp-content/uploads/2019/11/orcid_16x16.png" width="16" height="16" /></a>

Code in this package and git repository [https://gitlab.com/tyagilab/sars-cov-2/](https://gitlab.com/tyagilab/sars-cov-2/) is provided under a [MIT license](https://opensource.org/licenses/MIT). This documentation is provided under a [CC-BY-3.0 AU license](https://creativecommons.org/licenses/by/3.0/au/).

[Visit our lab website here.](https://bioinformaticslab.erc.monash.edu/) Contact Sonika Tyagi at [sonika.tyagi@monash.edu](mailto:sonika.tyagi@monash.edu).

# Index

- [Introduction](introduction.html)
- [Case study 1](case_study_1.html)
- [Case study 2](case_study_2.html)

# Running the script

Load the library.

```{r setup}
library(multiomics)
```

A script to reproduce our analysis for case study 1 is shown. [You can also download this here](https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/src/case_study_1/example.sh). This may take up to a few hours to run.

```
Rscript ../run_pipeline.R \
   ../../data/case_study_1/classes_diablo.txt  \
   --classes_secondary ../../data/case_study_1/pch.txt \
   --dropna_classes TRUE \
   --dropna_prop 0 \
   --data ../../data/case_study_1/diablo_proteome.txt ../../data/case_study_1/diablo_translatome.txt \
   --data_names proteome translatome \
   --mappings ../../data/case_study_1/proteome_mapfile.txt ../../data/case_study_1/translatome_mapfile.txt \
   --ncpus 6 \
   --diablocomp 0 \
   --diablo_keepx 5 10 12 14 16 18 20 30 \
   --icomp 24 \
   --pcomp 10 \
   --plsdacomp 4 \
   --splsdacomp 4 \
   --splsda_keepx 10 25 50 100 \
   --dist_plsda centroids.dist \
   --dist_splsda centroids.dist \
   --dist_diablo mahalanobis.dist \
   --contrib max \
   --outfile_dir ../../results/case_study_1/EXAMPLE \
   --rdata RData.RData \
   --plot Rplots.pdf \
   --args Rscript.sh
```

# Input data

## Biological context

## Summary

The data used as input to this pipeline available in gitlab:

- [biological class information](https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/data/case_study_1/classes_diablo.txt)
- [longitudinal measurement information](https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/data/case_study_1/pch.txt)
- [proteome mappings](https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/data/case_study_1/proteome_mapfile.txt)
- [translatome mappings](https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/data/case_study_1/translatome_mapfile.txt)
- [proteome](https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/data/case_study_1/diablo_proteome.txt)
- [translatome](https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/data/case_study_1/diablo_translatome.txt)

## Metadata

The class information is available as a vector:

## Data

The proteome and translatome data have 24 matched samples and an arbitrary number of features.

# Input data

For reference, you can also access all these loaded data below and results in the `RData` object. Data objects in both this walkthrough and the `RData` object have identical names. The code blocks in this walkthrough will reproduce the same data structures. Not all values may be identical since some functions may be non-deterministic. This is true even if a seed is specified, since `R >=3.6` these are not reproducible across machines.

<details>
  <summary>Click to expand code block</summary>
  ```{r load_data_obj, eval=FALSE}
  load("RData.RData")
  ```
</details>

Obtain the input data from the git repository.

<details>
  <summary>Click to expand code block</summary>
  ```{r get_data, eval=FALSE}
  url_rdata <- "https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/results/case_study_1/RData.RData"
  url_class <- "https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/data/case_study_1/classes_diablo.txt"
  url_pch <- "https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/data/case_study_1/pch.txt"
  url_prot_map <- "https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/data/case_study_1/proteome_mapfile.txt"
  url_tran_map <- "https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/data/case_study_1/translatome_mapfile.txt"
  url_prot <- "https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/data/case_study_1/diablo_proteome.txt"
  url_tran <- "https://gitlab.com/tyagilab/sars-cov-2/-/raw/master/data/case_study_1/diablo_translatome.txt"

  urls <- c(url_rdata, url_class, url_pch, url_prot_map, url_tran_map, url_prot, url_tran)
  file_names <- sapply(strsplit(urls, "/"), tail, 1)
  mapply(function(x, y) download.file(x, y), urls, file_names, SIMPLIFY=FALSE)
  if (any(file.exists(file_names)) != TRUE) {stop("Files incorrectly downloaded!")}
  ```
</details>

Load the data and metadata with the following functions.

<details>
  <summary>Click to expand code block</summary>
  ```{r load_data, message=FALSE}
  paths <- c("diablo_proteome.txt", "diablo_translatome.txt")
  mappings <- c("proteome_mapfile.txt", "translatome_mapfile.txt")
  classes <- parse_classes("classes_diablo.txt")
  pch <- parse_classes("pch.txt")
  data <- lapply(paths, parse_data, missing_as=NA, rmna=TRUE)
  mapped <- lapply(mappings, parse_mappings)
  data_names <- c("proteome", "translatome")
  ```
</details>

# Data quality control

Before analysing data further we perform standard checks for common quality issues.

## Accounting for missing values

We discovered a high proportion of missing values within the translatome data. Missing values in data can bias analyses. There are multiple ways to address this. In our case we use a mixture of filtering and imputation.

<details>
  <summary>Click to expand code block</summary>
  ```{r check_na, eval=TRUE}
  # you may need this line if NA is represented as 0 in your data
  # in this specific case study the data has already been cleaned
  data <- mapply(function(x) zero_to_na(x), data, SIMPLIFY=FALSE)
  missing <- lapply(data, count_missing)
  mapply(function(x, y) show_na_prop(x, y), data, data_names, SIMPLIFY=FALSE)
  ```
</details>

We corrected for the missing values in the translatome data (~47% of original data) by a mixture of filtering and imputation. We considered that filtering alone would be too aggressive and imputation alone would be ineffective. Filtering was performed by dropping all features which were not represented across each biological sample group.

<details>
  <summary>Click to expand code block</summary>
  ```{r remove_na, eval=TRUE}
  data <- lapply(data, remove_na_class, classes)
  ```
</details>

This reduced the quantity of missing values to ~17% of the original data. An imputation was performed with the NIPALS algorithm, which is effective on data with < 20% missing values. Note that imputation can take some time, increasing with data size and component count.

<details>
  <summary>Click to expand code block</summary>
  ```{r impute_na, eval=TRUE}
  # this step is important, some functions use the names internally
  names(data) <- data_names
  data_imp <- impute_missing(data, rep(24, length(data)), outdir="./")
  data <- replace_missing(data, data_imp)
  ```
</details>

> **NOTE**: This step also writes out the imputed data. Since imputation can take some time, this is mainly for convenience. You can load the imputed data directly if it meets your requirements.

To test that imputation has not introduced significant technical variation into the data, we observe the correlation between variates of the principal components.

> **NOTE**: All PCAs are centered and scaled.

<details>
  <summary>Click to expand code block</summary>
  ```{r compare_na, eval=TRUE}
  missing <- lapply(data, count_missing)
  pca_withna <- plot_pca_single(
    data, classes, pch=pch, ncomp=10,
    title=paste("With NA")
  )
  pca_impute <- plot_pca_single(
    data_imp, classes, pch=pch, ncomp=10,
    title=paste("Imputed")
  )
  heatmaps <- cor_imputed_unimputed(pca_withna, pca_impute, data_names)
  ```
</details>

In both cases, there is a strong correlation between the variates on at least the first 5 principal components corresponding to at least 50% of the variation in the data.

## Accounting for unwanted variation

We observed a "sample effect" in the data in the above PCA, which is likely caused by the longitudinal study design, where sets of cell cultures were resampled over a time series.

<details>
  <summary>Click to expand code block</summary>
  ```{r sample_effect, eval=TRUE}
  data_pca_multilevel <- plot_pca_multilevel(
    data, classes, pch=pch, ncomp=10,
    title=paste("With NA.")
  )
  data_pca_multilevel <- plot_pca_multilevel(
    data_imp, classes, pch=pch, ncomp=10,
    title=paste("Imputed.")
  )
  ```
</details>

# Single omics analyses

## Parameter tuning

## Diagnostic plots

## Results

# Multi omics analyses

## Parameter tuning

## Diagnostic plots

## Results

# Output data

Files output by the pipeline include:

- a `pdf` file of all plots generated by the pipeline
- tab-separated `txt` files containing feature contribution weights to each biological class
- tab-separated `txt` file containing correlations between each omics data block

[A `RData` object with all input and output is available in the git repository.](https://gitlab.com/tyagilab/sars-cov-2/-/blob/master/results/case_study_1/RData.RData) This is not included directly in the `multiomics` package because of size constraints, and includes data from two omics datasets.

# Acknowledgements

[Please refer to introduction.](introduction.html)

# References

[Please refer to introduction.](introduction.html)
